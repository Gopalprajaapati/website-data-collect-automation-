<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Scraper Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <style>
        :root {
            --sidebar-width: 250px;
            --topbar-height: 56px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: #2c3e50;
            color: white;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 20px;
            min-height: calc(100vh - var(--topbar-height));
        }
        
        .topbar {
            height: var(--topbar-height);
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            right: 0;
            left: var(--sidebar-width);
            z-index: 999;
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-left: 3px solid transparent;
        }
        
        .nav-link:hover, .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            border-left: 3px solid #3498db;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-in_progress {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .action-btn {
            padding: 5px 10px;
            font-size: 0.875rem;
        }
        
        .dataTables_wrapper .dataTables_filter input {
            border-radius: 20px;
            padding: 5px 15px;
            border: 1px solid #ddd;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            border-radius: 50% !important;
            margin: 0 2px;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #3498db !important;
            color: white !important;
            border: none !important;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-3 text-center">
            <h4 class="mb-0">Business Scraper</h4>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="/">
                    <i class="bi bi-speedometer2 me-2"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('keywords') }}">
                    <i class="bi bi-list-ul me-2"></i> Keywords
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('status') }}">
                    <i class="bi bi-info-circle me-2"></i> Status
                </a>
            </li>
        </ul>
    </div>

    <!-- Topbar -->
    <nav class="topbar navbar navbar-expand navbar-light">
        <div class="container-fluid">
            <div class="navbar-nav">
                <span class="navbar-text">
                    <i class="bi bi-calendar-check me-2"></i>
                    <span id="current-date"></span>
                </span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container-fluid">
            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="text-uppercase">Total Keywords</h6>
                                    <h2>{{ Keyword.query.count() }}</h2>
                                </div>
                                <i class="bi bi-list-ul" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="text-uppercase">Completed</h6>
                                    <h2>{{ Keyword.query.filter_by(status='completed').count() }}</h2>
                                </div>
                                <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-warning text-dark">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="text-uppercase">Pending</h6>
                                    <h2>{{ Keyword.query.filter_by(status='pending').count() }}</h2>
                                </div>
                                <i class="bi bi-hourglass" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Table -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">All Results</h5>
                    <div>
                        <button class="btn btn-sm btn-danger me-2" id="bulkDeleteBtn">
                            <i class="bi bi-trash"></i> Delete Selected
                        </button>
                        <button class="btn btn-sm btn-primary" id="exportBtn">
                            <i class="bi bi-download"></i> Export
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="resultsTable" class="table table-hover" style="width:100%">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll"></th>
                                    <th>Keyword</th>
                                    <th>Title</th>
                                    <th>Website</th>
                                    <th>Rating</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                    <th>Scraped At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via DataTables -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Result</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId">
                        <div class="mb-3">
                            <label for="editTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="editTitle">
                        </div>
                        <div class="mb-3">
                            <label for="editPhone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="editPhone">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveChangesBtn">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script>
    $(document).ready(function() {
        // Set current date
        $('#current-date').text(new Date().toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        }));

        // Initialize DataTable
        const table = $('#resultsTable').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: '/api/data',
                type: 'GET'
            },
            columns: [
                { 
                    data: 'id',
                    render: function(data, type, row) {
                        return `<input type="checkbox" class="row-checkbox" value="${data}">`;
                    },
                    orderable: false
                },
                { data: 'keyword' },
                { data: 'title' },
                { 
                    data: 'website',
                    render: function(data) {
                        return data ? `<a href="${data}" target="_blank">View</a>` : '';
                    }
                },
                { 
                    data: 'stars',
                    render: function(data, type, row) {
                        if (!data) return '';
                        return `<span class="badge bg-warning text-dark">
                            <i class="bi bi-star-fill"></i> ${data} ${row.reviews ? `(${row.reviews})` : ''}
                        </span>`;
                    }
                },
                { data: 'phone' },
                { 
                    data: 'status',
                    render: function(data) {
                        return `<span class="status-badge status-${data.replace(' ', '_')}">${data}</span>`;
                    }
                },
                { data: 'scraped_at' },
                { 
                    data: 'actions',
                    orderable: false,
                    searchable: false
                }
            ],
            responsive: true,
            lengthMenu: [10, 25, 50, 100],
            pageLength: 10,
            dom: '<"top"lf>rt<"bottom"ip>',
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search...",
                lengthMenu: "Show _MENU_ entries",
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                infoEmpty: "Showing 0 to 0 of 0 entries",
                infoFiltered: "(filtered from _MAX_ total entries)",
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                }
            }
        });

        // Select all checkbox
        $('#selectAll').on('click', function() {
            $('.row-checkbox').prop('checked', $(this).prop('checked'));
        });

        // Bulk delete
        $('#bulkDeleteBtn').on('click', function() {
            const selectedIds = $('.row-checkbox:checked').map(function() {
                return $(this).val();
            }).get();

            if (selectedIds.length === 0) {
                alert('Please select at least one result');
                return;
            }

            if (confirm(`Are you sure you want to delete ${selectedIds.length} selected results?`)) {
                $.ajax({
                    url: '/delete_results',
                    method: 'POST',
                    data: { result_ids: selectedIds },
                    success: function() {
                        table.ajax.reload();
                    }
                });
            }
        });

        // Export data
        $('#exportBtn').on('click', function() {
            window.location.href = '/export/all';
        });

        // Edit button handler
        $('#resultsTable').on('click', '.edit-btn', function() {
            const id = $(this).data('id');
            // Here you would load the data into the modal
            // For now we'll just show the modal
            $('#editModal').modal('show');
        });

        // Delete button handler
        $('#resultsTable').on('click', '.delete-btn', function() {
            const id = $(this).data('id');
            if (confirm('Are you sure you want to delete this result?')) {
                $.ajax({
                    url: '/delete_result/' + id,
                    method: 'POST',
                    success: function() {
                        table.ajax.reload();
                    }
                });
            }
        });

        // Save changes in modal
        $('#saveChangesBtn').on('click', function() {
            const id = $('#editId').val();
            const data = {
                title: $('#editTitle').val(),
                phone: $('#editPhone').val()
            };

            $.ajax({
                url: '/update_result/' + id,
                method: 'POST',
                data: data,
                success: function() {
                    $('#editModal').modal('hide');
                    table.ajax.reload();
                }
            });
        });
    });
    </script>
</body>
</html>